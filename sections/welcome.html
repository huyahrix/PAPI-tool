<template class="section-template">
  <section id="welcome" class="wrapper style1">
    <div class="inner">
      <div>
        <h2 style="display:inline-block;">node-mssql</h2>
        <ul style="display:block; margin: 0; padding: 0; float: right;" class="actions">
          <li><a href="#" id="paste-sample-button" class="button">Paste Sample</a></li>
        </ul>
      </div>
      <textarea id="query" cols="40" rows="5" placeholder="query"
        style="margin-bottom: 10px; font-size: 14px;"></textarea>
      <textarea id="params" cols="40" rows="7" placeholder="params"
        style="margin-bottom: 10px; font-size: 14px;"></textarea>
      <div>
        <ul class="actions" style="padding-left: 0; display:inline-block;">
          <li><a href=" #" id="process-button" class="button">Process</a></li>
        </ul>
        <ul class="actions" style="display:inline-block;">
          <li><a href="#" id="open-copied-window" class="button">Coppy</a></li>
        </ul>
      </div>
      <p id="result" style="display: none;"></p>
    </div>
  </section>
</template>
<script>
  const _ = require('underscore');
  window.onload = function () {
    document.getElementById("process-button").onclick = function () { process() };
    document.getElementById("paste-sample-button").onclick = function () { sample() };
    function process() {
      let query = document.getElementById("query").value;
      const params = document.getElementById("params").value;
      let objParams;
      try {
        const dJSON = require('dirty-json');
        objParams = dJSON.parse(params)
        console.log(JSON.stringify(objParams));
      } catch (e) {
        if (e) {
          alert(e);
        }
      }
      for (const item of objParams) {
        let value = item.value ? item.value : '';
        switch (item.type) {
          case 'DATETIME':
            const formatDate = DateTime.formatToDate(value) ? DateTime.formatToDate(value) : '';
            if (formatDate) {
              value = `'${formatDate}'`;
            } else {
              return { code: 'MSQ006', message: 'The input datetime is required.' };
            }
            break;
          case 'VARCHAR':
            value = `'${value}'`;
            break;
          case 'NVARCHAR':
            value = `N'${value}'`;
            break;
          default:
            value = `${value}`;
            break;
        }
        let regex = new RegExp(`(?:^|\\W)@${item.key}(?:$|\\W)`, "g");
        //console.log(regex);
        query = query.split(regex).join(value);
        //query = query.split(/(?:^|\W)@Reason(?:$|\W)/g).join(value);
      }
      const { clipboard } = require('electron');
      clipboard.writeText(query, 'selection');
      console.log(clipboard.readText('query'));

      document.getElementById("result").textContent = query;
      //document.getElementById("result").value = query;
      document.getElementById("result").style.display = "inline";
    }
    function sample() {
      document.getElementById("query").value = `\
EXEC W75P2112 @DivisionID, @UserID, @HostID, @TransID, @EmployeeID, @LeaveDateFrom, @LeaveDateTo, @LeaveTypeID, @Quantity, @Mode, @Reason , \
@IsRegisterType, @FormID, @1stAbsDayQuan, @LastAbsDayQuan, @ReasonCancel 
DELETE FROM D91T1010 WHERE KeyID = '15RL0Y700000315' And TableName = 'D15T2030_WebHR' AND DivisionID = 'QT'
      `;
      document.getElementById("params").value = `\
[{ key: 'DivisionID', type: 'VARCHAR', value: 'QT' },
{ key: 'UserID', type: 'VARCHAR', value: '00150' },
{ key: 'HostID', type: 'VARCHAR', value: '' },
{ key: 'TransID', type: 'VARCHAR', value: '15RL0Y700000314' },
{ key: 'EmployeeID', type: 'VARCHAR', value: '04050' },
{ key: 'LeaveDateFrom', type: 'VARCHAR', value: '2020-04-16' },
{ key: 'LeaveDateTo', type: 'VARCHAR', value: '2020-04-18' },
{ key: 'LeaveTypeID', type: 'VARCHAR', value: 'L020' },
{ key: 'Quantity', type: 'DECIMAL', value: 2.5 },
{ key: 'Mode', type: 'INT', value: 0 },
{ key: 'Reason', type: 'NVARCHAR', value: '' },
{ key: 'IsRegisterType', type: 'TINYINT', value: 0 },
{ key: 'FormID', type: 'VARCHAR', value: 'W75F2000' },
{ key: '1stAbsDayQuan', type: 'DECIMAL28', value: 0.5 },
{ key: 'LastAbsDayQuan', type: 'DECIMAL28', value: 1 },
{ key: 'ReasonCancel', type: 'VARCHAR', value: '' } ]`;
    };
  };
</script>